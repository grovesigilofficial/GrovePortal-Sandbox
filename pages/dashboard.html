<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard — Grove Portal</title>
  <link rel="stylesheet" href="../css/style.css" />
</head>
<body>
  <div class="container">
    <h1>Dashboard</h1>

    <div class="panel" id="dashboardPanel">
      <p id="dashCurrent">Current Time: —</p>
      <p id="dashDay">Uberman Day: —</p>
      <p id="dashElapsed">Time on Uberman: —</p>
      <p id="dashNextNap">Next Nap: —</p>
    </div>

    <a class="back" href="../index.html">← Back Home</a>
  </div>

  <script type="module">
    import { getCurrentSession } from '../js/admin/admin.js'; // re-use admin helper

    function two(n){ return n<10?'0'+n:n; }
    function hmsFromSeconds(sec){
      const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60;
      return `${two(h)}:${two(m)}:${two(s)}`;
    }

    async function tick(){
      const now = new Date();
      document.getElementById('dashCurrent').textContent = 'Current Time: ' + now.toLocaleTimeString();

      const session = await getCurrentSession();
      if(!session){
        document.getElementById('dashDay').textContent = 'Uberman Day: —';
        document.getElementById('dashElapsed').textContent = 'Time on Uberman: —';
        document.getElementById('dashNextNap').textContent = 'Next Nap: —';
        return;
      }

      const start = new Date(session.start_time);
      const diffMs = Date.now() - start.getTime();
      const day = Math.floor(diffMs / (1000*60*60*24)) + 1;
      document.getElementById('dashDay').textContent = 'Uberman Day: ' + day;

      const elapsedHms = new Date(diffMs).toISOString().substr(11,8);
      document.getElementById('dashElapsed').textContent = 'Time on Uberman: ' + elapsedHms;

      const naps = [0,4,8,12,16,20];
      const nowDate = new Date();
      let next = null;
      for(let h of naps){
        const cand = new Date(nowDate);
        cand.setHours(h,0,0,0);
        if(cand > nowDate){ next = cand; break; }
      }
      if(!next){ next = new Date(nowDate); next.setDate(next.getDate()+1); next.setHours(0,0,0,0); }
      document.getElementById('dashNextNap').textContent = 'Next Nap: ' + next.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    }

    tick();
    setInterval(tick,1000);
  </script>
</body>
</html>
